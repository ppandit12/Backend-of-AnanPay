# KYC Verification API Documentation 

This document describes the KYC (Know Your Customer) verification endpoints integrated with Didit API for identity verification. 

## Overview 

The KYC system allows users to verify their identity through Didit's verification service. Each user can have only one active verification session at a time. When a new session is created, it replaces any previous session for that user. 

## Base URL 
```
{API_BASE_URL}/api/kyc 
```

## Authentication  
All endpoints require proper authentication (implement based on your auth middleware).  

---

## Endpoints 

### 1. Create Verification Session 

Creates a new KYC verification session for a user with Didit API. If the user already has an existing session, it will be replaced with the new one.

**Endpoint:** `POST /api/kyc/create-session`

#### Request Body
```json
{
  "user_id": "string (required)",
  "callback_url": "string (optional)"
}
```

#### Request Parameters
| Parameter | Type | Required | Description | 
|-----------|------|----------|-------------| 
| `user_id` | String | Yes | The MongoDB ObjectId of the user | 
| `callback_url` | String | No | URL to redirect user after verification completion |

#### Success Response (201)
```json
{
  "success": true,
  "message": "Verification session created successfully",
  "data": {
    "session_id": "sess_abc123def456",
    "verification_url": "https://verification.didit.me/v2/session/sess_abc123def456",
    "workflow_id": "6a4fba7d-e3d3-414a-b4ab-cec032741426",
    "expires_at": "2025-09-18T10:30:00.000Z"
  }
}
```

#### Error Responses

**400 - Bad Request**
```json
{
  "success": false,
  "message": "user_id is required"
}
```

**404 - User Not Found**
```json
{
  "success": false,
  "message": "User not found"
}
```

**500 - Didit API Error**
```json
{
  "success": false,
  "message": "Didit API error",
  "error": {
    "detail": "Error details from Didit API"
  }
}
```

#### Example Request
```bash
curl -X POST {API_BASE_URL}/api/kyc/create-session \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "user_id": "60d0fe4f5311236168a109ca",
    "callback_url": "https://yourapp.com/kyc-callback"
  }'
```

---

### 2. Get Verification Status

Retrieves the current status of a user's KYC verification session. This endpoint fetches the latest status from Didit API and updates the local database.

**Endpoint:** `GET /api/kyc/status/{user_id}`

#### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `user_id` | String | Yes | The MongoDB ObjectId of the user |

#### Success Response (200)
```json
{
  "success": true,
  "data": {
    "session_id": "sess_abc123def456",
    "user_id": "60d0fe4f5311236168a109ca",
    "user_info": {
      "name": "John Doe",
      "email": "john.doe@example.com",
      "phone": 1234567890,
      "isKycApproved": false
    },
    "workflow_id": "6a4fba7d-e3d3-414a-b4ab-cec032741426",
    "verification_url": "https://verification.didit.me/v2/session/sess_abc123def456",
    "verification_result": {
      "session_id": "sess_abc123def456",
      "status": "Declined",
      "workflow_id": "6a4fba7d-e3d3-414a-b4ab-cec032741426",
      "features": ["ID_VERIFICATION", "FACE_MATCH", "IP_ANALYSIS"],
      "vendor_data": "60d0fe4f5311236168a109ca_1758103579622",
      "id_verification": {
        "status": "Declined",
        "document_type": "Identity Card",
        "document_number": "BV584J5D3",
        "date_of_birth": "1957-01-10",
        "first_name": "John",
        "last_name": "Doe",
        "warnings": []
      },
      "face_match": {
        "status": "Declined",
        "score": null,
        "warnings": []
      },
      "ip_analysis": {
        "status": "Approved",
        "ip_country": "India",
        "is_vpn_or_tor": false
      }
    },
    "created_at": "2025-09-17T10:30:00.000Z",
    "updated_at": "2025-09-17T10:30:00.000Z",
    "expires_at": "2025-09-18T10:30:00.000Z"
  }
}
```

#### Error Responses

**400 - Bad Request**
```json
{
  "success": false,
  "message": "user_id is required"
}
```

**404 - Session Not Found**
```json
{
  "success": false,
  "message": "No KYC session found for this user"
}
```

**200 - Didit API Unavailable**
```json
{
  "success": true,
  "message": "Session found (Didit API unavailable)",
  "data": {
    // Same structure as success response
    // But with cached data from database
  }
}
```

#### Example Request
```bash
curl -X GET {API_BASE_URL}/api/kyc/status/60d0fe4f5311236168a109ca \
  -H "Authorization: Bearer {your_token}"
```

---

### 3. Generate PDF Report

Downloads a PDF report of the user's KYC verification session. The PDF is generated by Didit and contains all verification details, document images, and results.

**Endpoint:** `GET /api/kyc/pdf/{user_id}`

#### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `user_id` | String | Yes | The MongoDB ObjectId of the user |

#### Success Response (200)
- **Content-Type:** `application/pdf`
- **Content-Disposition:** `attachment; filename="kyc-report-{user_name}-{timestamp}.pdf"`
- **Response:** Binary PDF file for download

#### Error Responses

**400 - Bad Request**
```json
{
  "success": false,
  "message": "user_id is required"
}
```

**404 - Session Not Found**
```json
{
  "success": false,
  "message": "No KYC session found for this user"
}
```

**400 - No Verification Results**
```json
{
  "success": false,
  "message": "No verification results available. Please complete the verification first."
}
```

**500 - PDF Generation Error**
```json
{
  "success": false,
  "message": "Failed to generate PDF from Didit API",
  "error": "Status: 500"
}
```

#### Example Request
```bash
curl -X GET {API_BASE_URL}/api/kyc/pdf/60d0fe4f5311236168a109ca \
  -H "Authorization: Bearer {your_token}" \
  -o "kyc-report.pdf"
```

#### Frontend Usage
```javascript
// Download PDF in browser
const downloadPDF = async (userId) => {
  const response = await fetch(`/api/kyc/pdf/${userId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kyc-report-${Date.now()}.pdf`;
    a.click();
    window.URL.revokeObjectURL(url);
  }
};
```

---

## Status Values

The system now uses Didit's native status values directly from `verification_result.status`:

| Status | Description |
|--------|-------------|
| `Approved` | User successfully completed verification |
| `Declined` | Verification failed or was rejected |
| `Pending` | Verification session created, user hasn't completed verification yet |
| `Expired` | Verification session expired |

**Note:** The status is always retrieved from `verification_result.status` field, which contains Didit's authoritative status.

---

## Database Schema

### KycSession Model
```javascript
{
  user_id: ObjectId,           // Reference to RegisterUser
  session_id: String,          // Unique session ID from Didit
  workflow_id: String,         // Didit workflow ID
  verification_url: String,    // URL for user to complete verification
  vendor_data: String,         // Unique identifier for tracking
  callback_url: String,        // Optional callback URL
  session_details: Object,     // Full response from Didit create session
  verification_result: Object, // Full response from Didit verification
  created_at: Date,            // Session creation timestamp
  updated_at: Date,            // Last update timestamp
  expires_at: Date             // Session expiration (24 hours)
}
```

**Note:** The `status` field has been removed as we now use Didit's status directly from `verification_result.status`.

---

## Integration Flow

### Frontend Integration

1. **Initiate KYC**
   ```javascript
   // Create verification session
   const response = await fetch('/api/kyc/create-session', {
     method: 'POST',
     headers: {
       'Content-Type': 'application/json',
       'Authorization': `Bearer ${token}`
     },
     body: JSON.stringify({
       user_id: currentUser.id,
       callback_url: 'https://yourapp.com/kyc-complete'
     })
   });
   
   const { data } = await response.json();
   
   // Redirect user to verification URL
   window.open(data.verification_url, '_blank');
   ```

2. **Check Status**
   ```javascript
   // Poll for status updates
   const checkStatus = async () => {
     const response = await fetch(`/api/kyc/status/${currentUser.id}`, {
       headers: {
         'Authorization': `Bearer ${token}`
       }
     });
     
     const { data } = await response.json();
     
     // Check Didit's status from verification_result
     if (data.verification_result?.status === 'Approved') {
       // Update UI - KYC approved
       updateUserKycStatus(true);
     } else if (data.verification_result?.status === 'Declined') {
       // Show error message
       showKycFailedMessage();
     }
   };
   
   // Check status every 30 seconds
   const statusInterval = setInterval(checkStatus, 30000);
   ```

3. **Download PDF Report**
   ```javascript
   // Download PDF report
   const downloadReport = async () => {
     const response = await fetch(`/api/kyc/pdf/${currentUser.id}`, {
       headers: {
         'Authorization': `Bearer ${token}`
       }
     });
     
     if (response.ok) {
       const blob = await response.blob();
       const url = window.URL.createObjectURL(blob);
       const a = document.createElement('a');
       a.href = url;
       a.download = 'kyc-report.pdf';
       a.click();
       window.URL.revokeObjectURL(url);
     }
   };
   ```

### Backend Behavior

- **Session Replacement**: When a user creates a new session, any existing session is completely replaced
- **Status Updates**: The system automatically updates user's `isKycApproved` field when verification is approved
- **PDF Generation**: Server-to-server communication with Didit (no browser required)
- **Error Handling**: Graceful fallback to cached data when Didit API is unavailable
- **Expiration**: Sessions automatically expire after 24 hours

---

## Configuration

### Environment Variables
```env
# These are hardcoded in the controller but can be moved to environment variables
DIDIT_API_KEY=uVTyIRXlKuvWK0MvJL_97wG8_y0qR2OnvcJZ45-fZU0
DIDIT_WORKFLOW_ID=6a4fba7d-e3d3-414a-b4ab-cec032741426
DIDIT_BASE_URL=https://verification.didit.me/v2
DIDIT_PDF_BASE_URL=https://verification.didit.me/v1
```

---

## Server Requirements

### For VPS/AWS Deployment
✅ **Node.js Runtime** - No browser required  
✅ **HTTP Client (axios)** - For API calls  
✅ **Buffer Handling** - For binary PDF data  
✅ **File System Access** - For serving responses  

**No GUI Requirements** - Perfect for headless servers

---

## Error Handling

The API implements comprehensive error handling for:

- **Validation Errors**: Missing required fields
- **User Not Found**: Invalid user_id
- **Didit API Errors**: External service failures
- **PDF Generation Errors**: PDF service unavailable
- **Database Errors**: Connection or query issues
- **Network Timeouts**: API call timeouts

All errors return consistent JSON structure:
```json
{
  "success": false,
  "message": "Error description",
  "error": "Additional error details (optional)"
}
```

---

## Security Considerations

1. **API Key Protection**: Didit API key is server-side only
2. **User Validation**: Always verify user exists before operations
3. **Session Uniqueness**: One session per user prevents confusion
4. **Data Validation**: All inputs are validated before processing
5. **Error Sanitization**: External API errors are sanitized before returning
6. **Binary Data Handling**: Safe PDF buffer management

---

## Testing

### Test with cURL

1. **Create Session**
```bash
curl -X POST localhost:3000/api/kyc/create-session \
  -H "Content-Type: application/json" \
  -d '{"user_id": "60d0fe4f5311236168a109ca"}'
```

2. **Check Status**
```bash
curl -X GET localhost:3000/api/kyc/status/60d0fe4f5311236168a109ca
```

3. **Download PDF**
```bash
curl -X GET localhost:3000/api/kyc/pdf/60d0fe4f5311236168a109ca \
  -o "kyc-report.pdf"
```

### Test Scenarios

- ✅ Create session for valid user
- ✅ Create multiple sessions (should replace previous)
- ✅ Check status for existing session
- ✅ Check status for non-existent session
- ✅ Download PDF for completed verification
- ✅ Handle PDF download before verification completion
- ✅ Handle Didit API failures
- ✅ Verify user KYC status updates after approval

---

## API Summary

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/kyc/create-session` | Create new verification session |
| GET | `/api/kyc/status/{user_id}` | Get verification status and results |
| GET | `/api/kyc/pdf/{user_id}` | Download PDF verification report |

All endpoints use `user_id` for consistency and simplicity.